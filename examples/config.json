{
          "name": "idx_customer_registration_date",
          "columns": ["registration_date"]
        }
      ]
    },
    {
      "sourceName": "orders",
      "targetName": "customer_orders",
      "primaryKey": "order_id",
      "dependsOn": ["customers"],
      "migrationOptions": {
        "migrateStructure": true,
        "migrateData": true,
        "truncateBeforeInsert": true,
        "dataFilter": "WHERE order_date > '2023-01-01'",
        "migrationOperation": "INSERT",
        "parallelMigration": true,
        "parallelizationFactor": 8
      },
      "columns": [
        {
          "source": "order_id",
          "target": "id",
          "type": "SERIAL",
          "autoIncrement": true
        },
        {
          "source": "customer_id",
          "target": "customer_id",
          "type": "INTEGER",
          "foreignKey": {
            "table": "customers",
            "column": "id"
          }
        },
        {
          "source": "order_date",
          "target": "created_at",
          "type": "TIMESTAMP WITH TIME ZONE"
        },
        {
          "source": "total_amount",
          "target": "total",
          "type": "NUMERIC(10,2)"
        },
        {
          "source": "status",
          "target": "status",
          "type": "VARCHAR(20)"
        }
      ],
      "indexesToCreate": [
        {
          "name": "idx_order_customer_id",
          "columns": ["customer_id"]
        },
        {
          "name": "idx_order_created_at",
          "columns": ["created_at"]
        }
      ]
    }
  ],
  "dataTransformations": [
    {
      "type": "SQL",
      "description": "Calculate customer balances",
      "targetTable": "customer_balances",
      "sql": "INSERT INTO customer_balances (customer_id, total_spent) SELECT customer_id, SUM(total) FROM customer_orders GROUP BY customer_id"
    }
  ],
  "validations": [
    {
      "type": "rowCount",
      "description": "Check customer counts",
      "sourceQuery": "SELECT COUNT(*) FROM customers WHERE created_at > '2023-01-01'",
      "targetQuery": "SELECT COUNT(*) FROM customers",
      "expectedResult": "equal"
    },
    {
      "type": "rowCount",
      "description": "Check order counts",
      "sourceQuery": "SELECT COUNT(*) FROM orders WHERE order_date > '2023-01-01'",
      "targetQuery": "SELECT COUNT(*) FROM customer_orders",
      "expectedResult": "equal"
    },
    {
      "type": "dataIntegrity",
      "description": "Check uniqueness of customer emails",
      "targetQuery": "SELECT COUNT(*) FROM customers WHERE email IN (SELECT email FROM customers GROUP BY email HAVING COUNT(*) > 1)",
      "expectedResult": 0
    }
  ],
  "errorHandling": {
    "onError": "stop",
    "retryAttempts": 3,
    "retryDelay": 5000
  },
  "logging": {
    "level": "info",
    "destination": "/var/log/migrations/customer_order_migration.log"
  },
  "postMigrationScripts": [
    "CREATE INDEX IF NOT EXISTS idx_customer_balances_customer_id ON customer_balances(customer_id)",
    "ANALYZE customers",
    "ANALYZE customer_orders",
    "ANALYZE customer_balances"
  ]
}
